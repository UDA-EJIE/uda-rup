const card1 = {
    usuario: 'user1',
    email: 'user1@mail.com',
    edad: 20,
    codCliente: 234,
    codigoPK: 1,
    condition: 'vip',
    credito: 100
};
const card2 = {
    usuario: 'user2',
    email: 'user2@mail.com',
    edad: 17,
    codCliente: 235,
    codigoPK: 2,
    condition: 'vip',
    credito: 100
};
const card3 = {
    usuario: 'user3',
    email: 'user3@mail.com',
    edad: 34,
    codCliente: 236,
    codigoPK: 3,
    condition: 'vip',
    credito: 100
};
const card4 = {
    usuario: 'user4',
    email: 'user4@mail.com',
    edad: 40,
    codCliente: 237,
    codigoPK: 4,
    condition: 'novip',
    credito: 100
};
const card5 = {
    usuario: 'user5',
    email: 'user5@mail.com',
    edad: 25,
    codCliente: 238,
    codigoPK: 5,
    condition: 'novip',
    credito: 100
};
const card6 = {
    usuario: 'user6',
    email: 'user6@mail.com',
    edad: 22,
    codCliente: 239,
    codigoPK: 6,
    condition: 'vip',
    credito: 100
};
const card7 = {
    usuario: 'user7',
    email: 'user7@mail.com',
    edad: 23,
    codCliente: 240,
    codigoPK: 7,
    condition: 'novip',
    credito: 100
};
const card8 = {
    usuario: 'user8',
    email: 'user8@mail.com',
    edad: 20,
    codCliente: 241,
    codigoPK: 8,
    condition: 'vip',
    credito: 100
};
const card9 = {
    usuario: 'user9',
    email: 'user9@mail.com',
    edad: 39,
    codCliente: 242,
    codigoPK: 9,
    condition: 'vip',
    credito: 100
};
const card10 = {
    usuario: 'user10',
    email: 'user10@mail.com',
    edad: 50,
    codCliente: 243,
    codigoPK: 10,
    condition: 'novip',
    credito: 100
};
const card11 = {
    usuario: 'user11',
    email: 'user11@mail.com',
    edad: 21,
    codCliente: 244,
    codigoPK: 11,
    condition: 'novip',
    credito: 100
};
const card12 = {
    usuario: 'user12',
    email: 'user12@mail.com',
    edad: 12,
    codCliente: 245,
    codigoPK: 12,
    condition: 'vip',
    credito: 100
};
const card13 = {
    usuario: 'user13',
    email: 'user13@mail.com',
    edad: 23,
    codCliente: 246,
    codigoPK: 13,
    condition: 'vip',
    credito: 100
};
const card14 = {
    usuario: 'user14',
    email: 'user14@mail.com',
    edad: 24,
    codCliente: 247,
    codigoPK: 14,
    condition: 'vip',
    credito: 100
};
const card15 = {
    usuario: 'user15',
    email: 'user15@mail.com',
    edad: 25,
    codCliente: 248,
    codigoPK: 15,
    condition: 'vip',
    credito: 100
};
const card16 = {
    usuario: 'user16',
    email: 'user63@mail.com',
    edad: 26,
    codCliente: 249,
    codigoPK: 16,
    condition: 'vip',
    credito: 100
};
const card17 = {
    usuario: 'user17',
    email: 'user17@mail.com',
    edad: 27,
    codCliente: 250,
    codigoPK: 17,
    condition: 'vip',
    credito: 100
};
const card18 = {
    usuario: 'user18',
    email: 'user18@mail.com',
    edad: 28,
    codCliente: 251,
    codigoPK: 18,
    condition: 'vip',
    credito: 100
};
const card19 = {
    usuario: 'user19',
    email: 'user19@mail.com',
    edad: 29,
    codCliente: 252,
    codigoPK: 19,
    condition: 'vip',
    credito: 100
};
const card20 = {
    usuario: 'user20',
    email: 'user20@mail.com',
    edad: 30,
    codCliente: 253,
    codigoPK: 20,
    condition: 'vip',
    credito: 100
};
const card21 = {
    usuario: 'user21',
    email: 'user21@mail.com',
    edad: 20,
    codCliente: 254,
    codigoPK: 21,
    condition: 'vip',
    credito: 100
};
const card22 = {
    usuario: 'user22',
    email: 'user22@mail.com',
    edad: 22,
    codCliente: 255,
    codigoPK: 22,
    condition: 'vip',
    credito: 100
};
const card23 = {
    usuario: 'user23',
    email: 'user23@mail.com',
    edad: 33,
    codCliente: 256,
    codigoPK: 23,
    condition: 'vip',
    credito: 100
};
const card24 = {
    usuario: 'user24',
    email: 'user24@mail.com',
    edad: 24,
    codCliente: 257,
    codigoPK: 24,
    condition: 'vip',
    credito: 100
};
const card25 = {
    usuario: 'user25',
    email: 'user25@mail.com',
    edad: 25,
    codCliente: 258,
    codigoPK: 25,
    condition: 'vip',
    credito: 100
};
const card26 = {
    usuario: 'user26',
    email: 'user26@mail.com',
    edad: 26,
    codCliente: 259,
    codigoPK: 26,
    condition: 'vip',
    credito: 100
};
const card27 = {
    usuario: 'user27',
    email: 'user26@mail.com',
    edad: 27,
    codCliente: 260,
    codigoPK: 27,
    condition: 'vip',
    credito: 100
};
const card28 = {
    usuario: 'user28',
    email: 'user28@mail.com',
    edad: 28,
    codCliente: 261,
    codigoPK: 28,
    condition: 'vip',
    credito: 100
};
const card29 = {
    usuario: 'user29',
    email: 'user29@mail.com',
    edad: 29,
    codCliente: 262,
    codigoPK: 29,
    condition: 'vip',
    credito: 100
};
const card30 = {
    usuario: 'user30',
    email: 'user30@mail.com',
    edad: 30,
    codCliente: 263,
    codigoPK: 30,
    condition: 'vip',
    credito: 100
};
const card31 = {
    usuario: 'user31 ',
    email: 'user31 @mail.com',
    edad: 31,
    codCliente: 264,
    codigoPK: 31,
    condition: 'vip',
    credito: 100
};
const card32 = {
    usuario: 'user32',
    email: 'user32@mail.com',
    edad: 32,
    codCliente: 265,
    codigoPK: 32,
    condition: 'vip',
    credito: 100
};
const filter1 = {
    selector: 'generated',
    text: 'Filter 1',
    data: {
        usuario: 'user12'
    },
    active: false,
    user: 'udaPruebas'
};
const filter2 = {
    selector: 'generated',
    text: 'Filter 2',
    data: {
        edad: 20,
    },
    active: true,
    user: 'udaPruebas'
};

const allregs = JSON.parse(JSON.stringify(
    [card1, card2, card3, card4, card5, card6, card7, card8, card9, card10, card11, card12,
        card13, card14, card15, card16, card17, card18, card19, card20, card21, card22,
        card23, card24, card25, card26, card27, card28, card29, card30, card31, card32
    ]));

var allregsFilter = JSON.parse(JSON.stringify([filter1, filter2]));

function getResult(req) {
    var filtered;
    if (req.body.filter) {
        filtered = allregs.filter((e) => {
            var matches = true;
            Object.keys(req.body.filter).forEach((val) => {
                if (req.body.filter[val] != e[val]) {
                    matches = false;
                }
            });
            return matches;
        });
    } else {
        filtered = JSON.parse(JSON.stringify(allregs));
    }

    var ordered = filtered; //TODO: Implementar ordenación
    ordered = (() => {
        let filterRes = filtered.slice(0);
        let idx = req.body.sidx.toLowerCase().split(',').reverse();
        let ord = req.body.sord.toLowerCase().split(',').reverse();

        idx.forEach((e, i) => {
            switch (e.trim()) {
            case 'usuario':
                filterRes.sort((a, b) => {
                    if (a.usuario < b.usuario) {
                        return -1;
                    }
                    if (a.usuario > b.usuario) {
                        return 1;
                    }
                    return 0;
                });
                break;
            case 'edad':
                filterRes.sort((a, b) => {
                    if (a.edad < b.edad) {
                        return -1;
                    }
                    if (a.edad > b.edad) {
                        return 1;
                    }
                    return 0;
                });
                break;
            case 'codcliente':
                filterRes.sort((a, b) => {
                    if (a.codCliente < b.codCliente) {
                        return -1;
                    }
                    if (a.codCliente > b.codCliente) {
                        return 1;
                    }
                    return 0;
                });
                break;
            }
            if (ord[i] && ord[i].trim() == 'desc') {
                filterRes.reverse();
            }
        });

        return filterRes;
    })();
    var paginasTotales;
    var paginated = (() => {
        let paginatedArray = [];
        let paginasCompletas = Math.floor(ordered.length / req.body.rows);
        if (ordered.length % req.body.rows != 0) {
            paginasTotales = paginasCompletas + 1;
        } else {
            paginasTotales = paginasCompletas;
        }
        //Separamos los registros por páginas
        for (let i = 0; i < paginasTotales; i++) {
            let tmpArr = ordered.slice(i * req.body.rows, (i + 1) * req.body.rows);
            paginatedArray.push(tmpArr);
        }
        return paginatedArray;
    })();

    var reorderedSelection = (() => {
        var rSelection = [];
        if(req.body.multiselection && req.body.multiselection.selectedRowsPerPage){
            req.body.multiselection.selectedRowsPerPage.forEach((arrElem) => {
                let tmpObj = {
                    page: arrElem.page,
                    pageLine: arrElem.line + 1,
                    tableLine: (req.body.rows * (arrElem.page - 1)) + arrElem.line + 1,
                    pk: {
                        codigoPK: String(arrElem.id).split('_').pop()
                    }
                };
                rSelection.push(tmpObj);
            });
        }
        return rSelection;
    })();
    var estructura = {
        page: req.body.page,
        rows: paginated[req.body.page - 1],
        total: paginasTotales,
        records: ordered.length,
        selectedAll: req.body.multiselection && req.body.multiselection.selectedAll,
        reorderedSelection: reorderedSelection
    };

    //Devolvemos los datos a la lista
    return estructura;
}
function getAllResultFilter () {
    var result = [];
    for (let i = 0; i < allregsFilter.length; i++) {
        result[i] = {
            selector: allregsFilter[i].selector,
            text: allregsFilter[i].text,
            data: JSON.stringify(allregsFilter[i].data),
            active: allregsFilter[i].active,
            user: allregsFilter[i].user
        };
    }
    return result;
}
function getDefaultResultFilter () {
    var result;
    for (let i = 0; i < allregsFilter.length; i++) {
        if (allregsFilter[i].active) {
            result = {
                selector: allregsFilter[i].selector,
                text: allregsFilter[i].text,
                data: JSON.stringify(allregsFilter[i].data),
                active: allregsFilter[i].active,
                user: allregsFilter[i].user
            };
            return result;
        }
    }
}
function addResultFilter (req) {
    var result = req.body.filtro;

    result.data = JSON.parse(result.data);

    if (result.active) {
        for (let i = 0; i < allregsFilter.length; i++) {
            allregsFilter[i].active = false;
        }
    }
    allregsFilter.push(result);
    return allregsFilter;
}
function deleteResultFilter (req) {
    var result = req.body.filtro;

    result.data = JSON.parse(result.data);
    
    for (let i = 0; i < allregsFilter.length; i++) {
        if (allregsFilter[i].text == result.text) {
            allregsFilter.splice(i, 1);
        }
    }
    return allregsFilter;
}
exports.filter = (req, res) => {
    if (req.body.filter.usuario == 'user20') {
        res.status(406).send('Error de prueba');
        return;
    }
    var resultado = getResult(req);
    res.status(200).json(resultado);
};
exports.multiFilterAll = (req, res) => {
    var resultado = getAllResultFilter(req);
    res.status(200).json(resultado);
};
exports.multiFilterDefault = (req, res) => {
    var resultado = getDefaultResultFilter(req);
    res.status(200).json(resultado);
};
exports.multiFilterAdd = (req, res) => {
    var resultado = addResultFilter(req);
    res.status(200).json(resultado);
};
exports.multiFilterDelete = (req, res) => {
    var resultado = deleteResultFilter(req);
    res.status(200).json(resultado);
};